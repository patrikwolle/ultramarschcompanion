<form class="upload-form" #f="ngForm" (ngSubmit)="sendForm()" novalidate>
  <div class="form-grid">
    <section class="token-area" aria-labelledby="token-label">
      <h3 id="token-label" class="upload-header">
        Token<span class="required-marker" aria-hidden="true">*</span>
      </h3>
      <div class="form-row">
        <label class="sr-only" for="token-input">Token</label>
        <input
          id="token-input"
          pInputText
          class="upload-input"
          [(ngModel)]="userToken"
          name="userToken"
          [disabled]="tokenLocked"
          [type]="tokenLocked ? 'password' : 'text'"
          autocomplete="off"
          inputmode="text"
          required
        />

        <button
          type="button"
          class="upload-btn token-toggle"
          [class.is-edit]="tokenLocked"
          [class.is-save]="!tokenLocked"
          (click)="toggleToken()"
          [attr.aria-pressed]="!tokenLocked"
          [attr.aria-label]="
            tokenLocked ? 'Token bearbeiten' : 'Token speichern'
          "
        >
          <i class="pi" [ngClass]="tokenLocked ? 'pi-pencil' : 'pi-save'"></i>
          <span class="sr-only">{{
            tokenLocked ? "Bearbeiten" : "Speichern"
          }}</span>
        </button>
      </div>
    </section>

    <section aria-labelledby="date-label">
      <h3 id="date-label" class="upload-header">
        Datum <span class="required-marker" aria-hidden="true">*</span>
      </h3>
      <div class="date-row">
        <p-datepicker
          #dp
          class="upload-date"
          [(ngModel)]="date"
          name="date"
          required
          dateFormat="dd.mm.yy"
          [showIcon]="false"
          inputId="datePicker"
          [showIcon]="false"
          [showOnFocus]="false"
          #dateCtrl="ngModel"
        ></p-datepicker>

        <button
          type="button"
          class="upload-btn"
          aria-label="Kalender öffnen"
          (mousedown)="$event.preventDefault()"
          (touchstart)="$event.preventDefault()"
          (pointerdown)="$event.preventDefault()"
          (touchend)="toggleCalendar($event)"
          (click)="toggleCalendar($event)"
        >
          <i class="pi pi-calendar"></i>
          <span class="sr-only">Kalender öffnen</span>
        </button>
      </div>
      <p
        class="field-error"
        *ngIf="dateCtrl.invalid && (dateCtrl.touched || f.submitted)"
      >
        Bitte ein Datum wählen.
      </p>
    </section>
    <section aria-labelledby="mode-label">
      <h3 id="mode-label" class="upload-header">Strecke bewältigt:</h3>
      <p-selectButton
        [options]="modes"
        [(ngModel)]="mode"
        name="mode"
        [allowEmpty]="false"
        optionLabel="label"
        optionValue="value"
        class="mode-toggle"
      >
      </p-selectButton>
    </section>
    <section aria-labelledby="len-label">
      <h3 id="len-label" class="upload-header">
        {{ mode === "feet" ? "Streckenlänge zu Fuß" : "Streckenlänge per Rad" }}
        <span class="required-marker" aria-hidden="true">*</span>
      </h3>

      <div class="form-row" *ngIf="mode === 'feet'">
        <label for="len-input" class="sr-only"
          >Streckenlänge zu Fuß (in km)</label
        >
        <input
          id="len-input"
          pInputText
          type="number"
          [(ngModel)]="length"
          name="length"
          #lengthCtrl="ngModel"
          class="upload-input"
          inputmode="decimal"
          required
          min="0"
          [ngClass]="{
            invalid: lengthCtrl.invalid && (lengthCtrl.touched || f.submitted)
          }"
        />
        <p
          class="field-error"
          *ngIf="lengthCtrl.errors?.['required'] && (lengthCtrl.touched || f.submitted)"
        >
          Bitte die Streckenlänge angeben.
        </p>
        <p
          class="field-error"
          *ngIf="lengthCtrl.errors?.['min'] && (lengthCtrl.touched || f.submitted)"
        >
          Der Wert muss ≥ 0 sein.
        </p>
      </div>

      <div class="form-row" *ngIf="mode === 'bike'">
        <label for="blen-input" class="sr-only"
          >Streckenlänge per Rad (in km)</label
        >
        <input
          id="blen-input"
          pInputText
          type="number"
          [(ngModel)]="bikeLength"
          name="bikeLength"
          #bikeLenCtrl="ngModel"
          class="upload-input"
          inputmode="decimal"
          required
          min="0"
          [ngClass]="{
            invalid: bikeLenCtrl.invalid && (bikeLenCtrl.touched || f.submitted)
          }"
        />
        <p
          class="field-error"
          *ngIf="bikeLenCtrl.errors?.['required'] && (bikeLenCtrl.touched || f.submitted)"
        >
          Bitte die Streckenlänge angeben.
        </p>
        <p
          class="field-error"
          *ngIf="bikeLenCtrl.errors?.['min'] && (bikeLenCtrl.touched || f.submitted)"
        >
          Der Wert muss ≥ 0 sein.
        </p>
      </div>
    </section>

    <section aria-labelledby="len-label">
      <h3 id="len-label" class="upload-header">
        {{ mode === "feet" ? "Höhenmeter zu Fuß" : "Höhenmeter per Rad" }}
        <span class="required-marker" aria-hidden="true">*</span>
      </h3>

      <div class="form-row" *ngIf="mode === 'feet'">
        <label for="len-input" class="sr-only">Höhenmeter zu Fuß (in m)</label>
        <input
          id="len-input"
          pInputText
          type="number"
          [(ngModel)]="height"
          name="height"
          #heightCtrl="ngModel"
          class="upload-input"
          inputmode="decimal"
          required
          min="0"
          [ngClass]="{
            invalid: heightCtrl.invalid && (heightCtrl.touched || f.submitted)
          }"
        />
        <p
          class="field-error"
          *ngIf="heightCtrl.errors?.['required'] && (heightCtrl.touched || f.submitted)"
        >
          Bitte die Höhenmeter angeben.
        </p>
        <p
          class="field-error"
          *ngIf="heightCtrl.errors?.['min'] && (heightCtrl.touched || f.submitted)"
        >
          Der Wert muss ≥ 0 sein.
        </p>
      </div>

      <div class="form-row" *ngIf="mode === 'bike'">
        <label for="blen-input" class="sr-only"
          >Höhenmeter per Rad (in m)</label
        >
        <input
          id="blen-input"
          pInputText
          type="number"
          [(ngModel)]="bikeHeight"
          name="bikeHeight"
          #bikeHCtrl="ngModel"
          class="upload-input"
          inputmode="decimal"
          required
          min="0"
          [ngClass]="{
            invalid: bikeHCtrl.invalid && (bikeHCtrl.touched || f.submitted)
          }"
        />
        <p
          class="field-error"
          *ngIf="bikeHCtrl.errors?.['required'] && (bikeHCtrl.touched || f.submitted)"
        >
          Bitte die Höhenmeter angeben.
        </p>
        <p
          class="field-error"
          *ngIf="bikeHCtrl.errors?.['min'] && (bikeHCtrl.touched || f.submitted)"
        >
          Der Wert muss ≥ 0 sein.
        </p>
      </div>
    </section>

    <section aria-labelledby="notice-label">
      <h3 id="notice-label" class="upload-header">Notiz an das Team</h3>
      <div class="form-row">
        <label for="bh-input" class="sr-only">Notiz an das Team</label>
        <input
          id="notice-input"
          pInputText
          type="text"
          [(ngModel)]="notice"
          name="notice"
          class="upload-input"
          inputmode="full-width-latin"
          min="0"
        />
      </div>
    </section>

    <section class="full" aria-labelledby="shot-label">
      <h3 id="shot-label" class="upload-header">
        Screenshot <span class="required-marker" aria-hidden="true">*</span>
      </h3>
      <label class="sr-only" for="upload-file">Screenshot (Pflichtfeld)</label>

      <div class="form-row">
        <p-fileupload
          class="upload-file"
          mode="basic"
          name="upload"
          chooseIcon="pi pi-upload"
          chooseLabel="Bild wählen"
          accept="image/*"
          [auto]="true"
          [maxFileSize]="1000000000"
          (onSelect)="onFileSelect($event)"
          (onUpload)="onServerUpload($event)"
          (onClear)="removeImage()"
          [attr.aria-label]="'Screenshot hochladen'"
          [(ngModel)]="upload"
          name="height"
          #uploadCtrl="ngModel"
        ></p-fileupload>
      </div>
      <div *ngIf="uploadedImageUrl" class="upload-preview">
        <img [src]="uploadedImageUrl" alt="Bildvorschau" />

        <div class="file-meta">
          <div class="file-name" [title]="uploadedFileName">
            {{ uploadedFileName }}
          </div>

          <div class="file-size">{{ formatBytes(uploadedFileSize) }}</div>

          <button
            type="button"
            class="upload-btn cancel"
            (click)="removeImage()"
          >
            Bild entfernen
          </button>
        </div>
      </div>
    </section>
    <p class="upload-success" *ngIf="uploadSuccess">
      Datei wurde erfolgreich hochgeladen.
    </p>

    <div class="actions full">
      <button type="button" class="upload-btn cancel" (click)="cancel()">
        Abbrechen
      </button>
      <button type="submit" class="upload-btn save" [disabled]="f.invalid">
        Speichern
      </button>
    </div>
  </div>
</form>
